{% extends 'core/base.html' %}

{% block content %}
<div class="dashboard-layout animate-fade-in">
    <!-- Left Sidebar: Live Log -->
    <aside
        style="height: calc(100vh - 140px); position: sticky; top: 100px; display: flex; flex-direction: column; gap: 1rem;">
        <div class="glass-card" style="padding: 1rem; flex: 1; display: flex; flex-direction: column;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                <h3 style="font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fa-solid fa-clock-rotate-left" style="color: var(--primary);"></i> Detection Log
                </h3>
                <span style="font-size: 0.8rem; color: var(--text-muted);">Real-time</span>
            </div>

            <div id="detection-log"
                style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0.75rem; padding-right: 0.5rem;">
                <!-- Detections will be injected here via JS -->
                <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                    <i class="fa-solid fa-spinner"></i> Waiting for data...
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content: Video Feed -->
    <div style="display: flex; flex-direction: column; gap: 1rem;">
        <div class="glass-card" style="padding: 0.5rem; position: relative; overflow: hidden;">
            <!-- Header on top of video -->
            <div
                style="position: absolute; top: 1.5rem; left: 1.5rem; z-index: 10; background: rgba(0,0,0,0.6); padding: 0.5rem 1rem; border-radius: 8px; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1);">
                <span class="status-dot" style="display: inline-block; margin-right: 0.5rem;"></span>
                LIVE FEED - Camera 01
            </div>

            <div style="position: absolute; top: 1.5rem; right: 1.5rem; z-index: 10;">
                <span
                    style="color: var(--danger); font-weight: 700; background: rgba(0,0,0,0.6); padding: 0.25rem 0.75rem; border-radius: 4px; border: 1px solid var(--danger);">REC</span>
            </div>

            <!-- Video Frame -->
            <div
                style="width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; overflow: hidden; position: relative; border: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center;">

                {% if start_requested %}
                <img src="{% url 'video_feed' %}" alt="Live Video Feed"
                    style="width: 100%; height: 100%; object-fit: contain;">

                <!-- HUD Overlay -->
                <div class="hud-overlay" style="position: absolute; inset: 0; pointer-events: none;">
                    <div class="hud-corner hud-tl"></div>
                    <div class="hud-corner hud-tr"></div>
                    <div class="hud-corner hud-bl"></div>
                    <div class="hud-corner hud-br"></div>

                    <!-- Target Reticle -->
                    <div
                        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px; border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 50%;">
                        <div
                            style="position: absolute; top: 50%; left: -10px; width: 20px; height: 1px; background: var(--primary);">
                        </div>
                        <div
                            style="position: absolute; top: 50%; right: -10px; width: 20px; height: 1px; background: var(--primary);">
                        </div>
                        <div
                            style="position: absolute; left: 50%; top: -10px; width: 1px; height: 20px; background: var(--primary);">
                        </div>
                        <div
                            style="position: absolute; left: 50%; bottom: -10px; width: 1px; height: 20px; background: var(--primary);">
                        </div>
                    </div>

                    <!-- Scan Line -->
                    <div class="scan-line"></div>
                </div>
                {% else %}
                <!-- Offline Placeholder -->
                <div style="text-align: center; color: var(--text-muted); opacity: 0.6;">
                    <i class="fa-solid fa-video-slash"
                        style="font-size: 4rem; margin-bottom: 1.5rem; display: block;"></i>
                    <h2 style="font-weight: 400;">Detection Core Offline</h2>
                    <p style="font-size: 0.9rem;">Click "Start Detection" to initialize hardware</p>
                </div>
                {% endif %}
            </div>

            <!-- Controls -->
            <div style="padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 0.9rem; color: var(--text-muted);">
                    <i class="fa-solid fa-server"></i> Status:
                    {% if start_requested %}
                    <strong style="color: var(--status-active);">ACTIVE</strong>
                    {% else %}
                    <strong style="color: var(--status-standby);">STANDBY</strong>
                    {% endif %}
                </div>
                <div style="display: flex; gap: 1rem;">
                    {% if start_requested %}
                    <a href="{% url 'stop_camera' %}" class="btn-secondary"
                        style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.2); color: #ef4444;"><i
                            class="fa-solid fa-circle-stop"></i> Stop Detection</a>
                    {% else %}
                    <a href="{% url 'scan' %}?start=1" class="btn-primary glow-btn"
                        style="background: var(--success); border: none;"><i class="fa-solid fa-play"></i> Start
                        Detection</a>
                    {% endif %}
                    <a href="{% url 'gallery' %}" class="btn-secondary"><i class="fa-solid fa-database"></i>
                        Database</a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .scan-line {
        position: absolute;
        width: 100%;
        height: 2px;
        background: rgba(99, 102, 241, 0.5);
        box-shadow: 0 0 10px rgba(99, 102, 241, 0.8);
        animation: none;
        /* Stopped for performance */
    }

    @keyframes scanMove {
        0% {
            top: 0;
            opacity: 0;
        }

        20% {
            opacity: 1;
        }

        80% {
            opacity: 1;
        }

        100% {
            top: 100%;
            opacity: 0;
        }
    }

    .log-item {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--glass-border);
        padding: 0.75rem;
        border-radius: 8px;
        display: flex;
        gap: 0.75rem;
        align-items: center;
        animation: slideInLeft 0.3s ease-out;
    }

    @keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-10px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
</style>

<script>
    const seenFaces = new Set();

    function updateLog() {
        fetch("{% url 'get_recognized_faces' %}")
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('detection-log');

                if (data.faces.length === 0) {
                    if (container.children.length === 0 || container.innerHTML.includes('Waiting')) {
                        container.innerHTML = `
                            <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                                <i class="fa-solid fa-radar"></i> Scanning for faces...
                            </div>
                         `;
                    }
                    return;
                }

                // If we have faces, clear placeholder
                if (container.innerHTML.includes('Scanning') || container.innerHTML.includes('Waiting')) {
                    container.innerHTML = '';
                }

                data.faces.forEach(face => {
                    // One-time logging logic: Skip if already seen in this session
                    if (seenFaces.has(face.name)) {
                        return;
                    }

                    // Mark as seen
                    seenFaces.add(face.name);

                    const item = document.createElement('div');
                    item.className = 'log-item';
                    item.dataset.name = face.name;

                    item.innerHTML = `
                        <div style="width: 40px; height: 40px; background: rgba(99,102,241,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary);">
                            <i class="fa-solid fa-user"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-main);">${face.name}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">
                                ${face.department || 'Unknown Dept'} | ${face.class_name || 'N/A'}
                            </div>
                        </div>
                        <div style="font-size: 0.7rem; color: var(--success);">
                            <i class="fa-solid fa-check"></i> Match
                        </div>
                    `;

                    container.insertBefore(item, container.firstChild);

                    // Keep log size manageable (though duplicates are gone, limit total unique entries)
                    if (container.children.length > 50) {
                        container.lastElementChild.remove();
                    }
                });
            })
            .catch(error => console.error('Error fetching faces:', error));
    }

    // Poll every 5 seconds to reduce server load and terminal spam
    setInterval(updateLog, 5000);
</script>
{% endblock %}